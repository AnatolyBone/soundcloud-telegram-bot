<% if (typeof query !== 'undefined' && query.ping) { %>
  <div class="alert <%= query.ping==='ok'?'alert-success':'alert-danger' %>" data-autohide>
    <%= query.ping==='ok'?'Канал доступен':'Ошибка отправки в канал' %>
  </div>
<% } %>

<div class="d-flex flex-wrap gap-3 mb-4">
  <div class="card card-metric shadow-sm flex-fill"><div class="card-body">
    <div class="text-muted">Пользователи</div>
    <div class="h4 mb-0"><%= stats.total_users %></div>
  </div></div>
  <div class="card card-metric shadow-sm flex-fill"><div class="card-body">
    <div class="text-muted">Активные сегодня</div>
    <div class="h4 mb-0"><%= stats.active_today %></div>
  </div></div>
  <div class="card card-metric shadow-sm flex-fill"><div class="card-body">
    <div class="text-muted">Загрузки (всего)</div>
    <div class="h4 mb-0"><%= stats.total_downloads %></div>
  </div></div>
  <form method="post" action="/admin/test-storage-send" class="align-self-start">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <button class="btn btn-outline-primary mt-2"><i class="bi bi-broadcast"></i> Проверить канал</button>
  </form>
</div>

<div class="row g-4">
  <div class="col-12 col-xl-8">
    <div class="card shadow-sm">
      <div class="card-header">Регистрации / Загрузки / Активные</div>
      <div class="card-body chart-wrap"><canvas id="chartCombined"></canvas></div>
    </div>
  </div>
  <div class="col-12 col-xl-4">
    <div class="card shadow-sm mb-4">
      <div class="card-header">Активность по часам</div>
      <div class="card-body chart-wrap" style="height:280px"><canvas id="chartHours"></canvas></div>
    </div>
    <div class="card shadow-sm">
      <div class="card-header">Активность по дням недели</div>
      <div class="card-body chart-wrap" style="height:280px"><canvas id="chartWeek"></canvas></div>
    </div>
  </div>
</div>

<script>
  const combined = <%- JSON.stringify(chartDataCombined) %>;
  const byHour = <%- JSON.stringify(chartDataHourActivity) %>;
  const byWeek = <%- JSON.stringify(chartDataWeekdayActivity) %>;
  const ctx1 = document.getElementById('chartCombined');
  if (ctx1) new Chart(ctx1, { type:'line', data: combined, options:{ responsive:true, maintainAspectRatio:false } });
  const ctx2 = document.getElementById('chartHours');
  if (ctx2) new Chart(ctx2, { type:'bar', data: byHour, options:{ responsive:true, maintainAspectRatio:false } });
  const ctx3 = document.getElementById('chartWeek');
  if (ctx3) new Chart(ctx3, { type:'bar', data: byWeek, options:{ responsive:true, maintainAspectRatio:false } });
</script>