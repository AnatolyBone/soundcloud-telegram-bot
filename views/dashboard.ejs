<% title = '–ê–¥–º–∏–Ω–∫–∞'; page = 'dashboard'; %>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<section class="content-header">
  <div class="container-fluid d-flex justify-content-between align-items-center mb-3">
    <h1>üìä –ê–¥–º–∏–Ω–∫–∞</h1>
    <small>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <%= user ? (user.username || user.first_name) : '–ì–æ—Å—Ç—å' %></small>
  </div>
</section>

<!-- –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞ -->
<form method="get" action="/dashboard" class="mb-3 d-flex gap-2 align-items-center flex-wrap">
  <label for="periodSelectMain" class="form-label mb-0">–ü–µ—Ä–∏–æ–¥:</label>
  <select id="periodSelectMain" name="period" class="form-select form-select-sm" style="width: auto;" onchange="this.form.submit()">
    <option value="7" <%= period === '7' ? 'selected' : '' %>>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
    <option value="30" <%= period === '30' ? 'selected' : '' %>>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
    <% lastMonths.forEach(m => { %>
      <option value="<%= m.value %>" <%= period === m.value ? 'selected' : '' %>><%= m.label %></option>
    <% }) %>
    <option value="all" <%= period === 'all' ? 'selected' : '' %>>–í–µ—Å—å –ø–µ—Ä–∏–æ–¥</option>
  </select>
  <a href="/export?period=<%= encodeURIComponent(period) %>" class="btn btn-outline-secondary ms-2">–í—ã–≥—Ä—É–∑–∏—Ç—å CSV</a>
</form>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
<section class="content">
  <div class="container-fluid">

    <!-- –í–∫–ª–∞–¥–∫–∏ -->
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab" aria-controls="stats" aria-selected="true">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#usersTab" type="button" role="tab" aria-controls="usersTab" aria-selected="false">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="broadcast-tab" data-bs-toggle="tab" data-bs-target="#broadcastTab" type="button" role="tab" aria-controls="broadcastTab" aria-selected="false">–†–∞—Å—Å—ã–ª–∫–∞</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analyticsTab" type="button" role="tab" aria-controls="analyticsTab" aria-selected="false">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="retention-tab" data-bs-toggle="tab" data-bs-target="#retentionTab" type="button" role="tab" aria-controls="retentionTab" aria-selected="false">–£–¥–µ—Ä–∂–∞–Ω–∏–µ –∏ –í–æ—Ä–æ–Ω–∫–∞</button>
      </li>
    </ul>

    <div class="tab-content mt-3" id="dashboardTabsContent">

      <!-- –í–∫–ª–∞–¥–∫–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="tab-pane fade show active" id="stats" role="tabpanel" aria-labelledby="stats-tab">

        <!-- –ù–û–í–´–ô –ë–õ–û–ö: Real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–∏ -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="info-box bg-primary">
                    <span class="info-box-icon"><i class="fas fa-cogs"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">–ó–∞–¥–∞—á –≤ —Ä–∞–±–æ—Ç–µ</span>
                        <span class="info-box-number" id="queueActive">...</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-box bg-secondary">
                    <span class="info-box-icon"><i class="fas fa-hourglass-half"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">–ó–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥–∏</span>
                        <span class="info-box-number" id="queueSize">...</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê -->

        <form method="GET" action="/dashboard" class="d-flex align-items-center gap-3 mb-3 flex-wrap">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="showInactive" name="showInactive" value="true" <%= showInactive ? 'checked' : '' %>>
            <label class="form-check-label" for="showInactive">–ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö</label>
          </div>
          <button type="submit" class="btn btn-primary btn-sm">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </form>

        <div class="row mb-3">
          <div class="col-md-4">
            <div class="info-box bg-info">
              <span class="info-box-icon"><i class="fas fa-users"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
                <span class="info-box-number"><%= stats.totalUsers %></span>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="info-box bg-success">
              <span class="info-box-icon"><i class="fas fa-download"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">–í—Å–µ–≥–æ –∑–∞–≥—Ä—É–∑–æ–∫</span>
                <span class="info-box-number"><%= stats.totalDownloads %></span>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="info-box bg-warning">
              <span class="info-box-icon"><i class="fas fa-star"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">–¢–∞—Ä–∏—Ñ—ã (Free/Plus/Pro/Unlim)</span>
                <span class="info-box-number">
                  Free: <%= stats.free %>, Plus: <%= stats.plus %>, Pro: <%= stats.pro %>, Unlim: <%= stats.unlimited %>
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="card card-primary card-outline">
          <div class="card-header">
            <h3 class="card-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –ó–∞–≥—Ä—É–∑–∫–∏, –ê–∫—Ç–∏–≤–Ω—ã–µ</h3>
          </div>
          <div class="card-body">
            <canvas id="combinedChart" style="height: 250px;"></canvas>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-6">
            <div class="card card-info card-outline">
              <div class="card-header">
                <h3 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º</h3>
              </div>
              <div class="card-body">
                <canvas id="hourActivityChart" style="height: 250px;"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card card-info card-outline">
              <div class="card-header">
                <h3 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</h3>
              </div>
              <div class="card-body">
                <canvas id="weekdayActivityChart" style="height: 250px;"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-secondary card-outline mt-3">
          <div class="card-header">
            <h3 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–∞—Ç–µ –∏ —á–∞—Å—É (—Ç–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞)</h3>
          </div>
          <div class="card-body" style="height: 400px;">
            <canvas id="heatmapChart"></canvas>
          </div>
          <details class="mt-3">
            <summary>–ü–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –¥–∞—Ç–µ –∏ —á–∞—Å—É (JSON)</summary>
            <pre><%= JSON.stringify(stats.activityByDayHour || {}, null, 2) %></pre>
          </details>
        </div>

        <div class="card card-danger card-outline mt-3">
          <div class="card-header">
            <h3 class="card-title">–° —Ç–∞—Ä–∏—Ñ–æ–º, –∏—Å—Ç–µ–∫–∞—é—â–∏–º –≤ –±–ª–∏–∂–∞–π—à–∏–µ 3 –¥–Ω—è</h3>
          </div>
          <div class="card-body">
            <% if (expiringSoon.length === 0) { %>
              <p>–ù–µ—Ç —Ç–∞–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
            <% } else { %>
              <ul class="list-group">
                <% expiringSoon.forEach(u => { %>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><%= u.first_name %> (<%= u.username ? '@' + u.username : '‚Äî' %>)</span>
                    <span>–î–æ <%= new Date(u.premium_until).toLocaleDateString() %></span>
                  </li>
                <% }) %>
              </ul>
              <nav aria-label="–ü–∞–≥–∏–Ω–∞—Ü–∏—è" class="mt-3 d-flex justify-content-center">
                <ul class="pagination mb-0">
                  <% if (expiringOffset > 0) { %>
                    <li class="page-item">
                      <button class="page-link" onclick="changePage(-1)">‚Üê –ù–∞–∑–∞–¥</button>
                    </li>
                  <% } %>
                  <% if (expiringOffset + expiringLimit < expiringCount) { %>
                    <li class="page-item">
                      <button class="page-link" onclick="changePage(1)">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
                    </li>
                  <% } %>
                </ul>
              </nav>
              <p class="text-center text-muted">–ü–æ–∫–∞–∑–∞–Ω–æ <%= expiringOffset + 1 %>‚Äì<%= Math.min(expiringOffset + expiringLimit, expiringCount) %> –∏–∑ <%= expiringCount %></p>
            <% } %>
          </div>
        </div>

        <div class="card card-light card-outline mt-3">
          <div class="card-header">
            <h3 class="card-title">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞</h3>
          </div>
          <div class="card-body p-0">
            <table class="table table-striped table-hover mb-0">
              <thead>
                <tr>
                  <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                  <th>–ö–æ–ª-–≤–æ</th>
                </tr>
              </thead>
              <tbody>
                <% referralStats.forEach(source => { %>
                  <tr>
                    <td><%= source.source ? source.source.replace(/</g, "&lt;").replace(/>/g, "&gt;") : '‚Äî' %></td>
                    <td><%= source.count %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>

      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
      <div class="tab-pane fade" id="usersTab" role="tabpanel" aria-labelledby="users-tab">
        <table id="usersTable" class="table table-bordered table-hover w-100 text-nowrap">
          <thead>
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>–ò–º—è</th>
              <th>–°–∫–∞—á–∞–Ω–æ</th>
              <th>–õ–∏–º–∏—Ç</th>
              <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
              <th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
              <th>–¢–∞—Ä–∏—Ñ</th>
               <th>1+1</th>
               <th>–°–±—Ä–æ—Å</th>
            </tr>
          </thead>
          <tbody>
            <% users.forEach(user => { %>
              <tr class="<%= !user.active ? 'table-secondary' : '' %>">
                <td><%= user.id %></td>
                <td><%= user.username ? '@' + user.username : '' %></td>
                <td>
                  <%= user.first_name %>
                  <% if (user.created_at && new Date(user.created_at).getTime() > Date.now() - 24 * 60 * 60 * 1000) { %>
                    <span class="badge bg-info text-dark">üÜï</span>
                  <% } %>
                </td>
                <td><%= user.total_downloads || 0 %></td>
                <td><%= user.premium_limit %></td>
                <td><%= user.created_at ? new Date(user.created_at).toLocaleDateString() : '-' %></td>
                <td><%= user.last_active ? new Date(user.last_active).toLocaleDateString() : '-' %></td>
                <td>
                  <% if (!user.last_active) { %>üî¥
                  <% } else if (new Date(user.last_active) > Date.now() - 24 * 60 * 60 * 1000) { %>üü¢
                  <% } else { %>üü°
                  <% } %>
                </td>
                <td><%= user.referral_source ? user.referral_source.replace(/</g, "&lt;").replace(/>/g, "&gt;") : '‚Äî' %></td>
                <td>
                  <form method="POST" action="/set-tariff" class="d-flex align-items-center gap-2 m-0">
                    <input type="hidden" name="userId" value="<%= user.id %>">
                    <select name="limit" class="form-select form-select-sm">
                      <option value="10" <%= user.premium_limit === 10 ? 'selected' : '' %>>Free</option>
                      <option value="50" <%= user.premium_limit === 50 ? 'selected' : '' %>>Plus</option>
                      <option value="100" <%= user.premium_limit === 100 ? 'selected' : '' %>>Pro</option>
                      <option value="1000" <%= user.premium_limit >= 1000 ? 'selected' : '' %>>Unlimited</option>
                    </select>
                    <button type="submit" class="btn btn-primary btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                  </form>
                </td>
                <td><%= user.promo_1plus1_used ? '‚úÖ' : '‚ùå' %></td>
                <td>
                  <form action="/admin/reset-promo/<%= user.id %>" method="POST" onsubmit="return confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–º–æ —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é?')">
                    <button class="btn btn-sm btn-warning">–°–±—Ä–æ—Å–∏—Ç—å</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
      <div class="tab-pane fade" id="broadcastTab" role="tabpanel" aria-labelledby="broadcast-tab">...</div>
      <div class="tab-pane fade" id="analyticsTab" role="tabpanel" aria-labelledby="analytics-tab">...</div>
      <div class="tab-pane fade" id="retentionTab" role="tabpanel" aria-labelledby="retention-tab">...</div>

    </div>
  </div>
</section>

<!-- –õ–æ–≥–∏ –∑–∞–¥–∞—á (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) -->
<section class="mt-5">
  <h3>–õ–æ–≥–∏ –∑–∞–¥–∞—á</h3>
  <% if (taskLogs && taskLogs.length) { %>
    <pre style="max-height: 300px; overflow-y: auto; background: #222; color: #eee; padding: 1rem; border-radius: 4px;"><%= taskLogs.join('\n') %></pre>
  <% } else { %>
    <p>–õ–æ–≥–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</p>
  <% } %>
</section>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // DataTables –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    new DataTable('#usersTable', {
      paging: true,
      searching: true,
      ordering: true,
      order: [[0, 'desc']],
      scrollX: true,
      language: { url: 'https://cdn.datatables.net/plug-ins/1.10.25/i18n/Russian.json' }
    });

    // –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è —Å–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫
    window.changePage = function(dir) {
      const url = new URL(window.location.href);
      let offset = parseInt(url.searchParams.get('expiringOffset')) || 0;
      offset += dir * <%= expiringLimit %>;
      if (offset < 0) offset = 0;
      url.searchParams.set('expiringOffset', offset);
      window.location.href = url.toString();
    };

    // --- –ù–û–í–´–ô –ë–õ–û–ö: Real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–∏ ---
    const queueActiveEl = document.getElementById('queueActive');
    const queueSizeEl = document.getElementById('queueSize');

    async function updateQueueStatus() {
        try {
            const response = await fetch('/api/queue-status');
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            queueActiveEl.textContent = data.active;
            queueSizeEl.textContent = data.size;
        } catch (e) {
            queueActiveEl.textContent = '–û—à–∏–±–∫–∞';
            queueSizeEl.textContent = '–û—à–∏–±–∫–∞';
        }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–∞–∑—É –∏ –ø–æ—Ç–æ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    updateQueueStatus();
    setInterval(updateQueueStatus, 5000);
    // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---

    // –ì—Ä–∞—Ñ–∏–∫–∏ –Ω–∞ Chart.js
    if (document.getElementById('combinedChart')) {
        new Chart(document.getElementById('combinedChart').getContext('2d'), {
            type: 'line', data: <%- JSON.stringify(chartDataCombined || {}) %>,
            options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
        });
    }
    if (document.getElementById('hourActivityChart')) {
        new Chart(document.getElementById('hourActivityChart').getContext('2d'), {
            type: 'bar', data: <%- JSON.stringify(chartDataHourActivity || {}) %>,
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }
    if (document.getElementById('weekdayActivityChart')) {
        new Chart(document.getElementById('weekdayActivityChart').getContext('2d'), {
            type: 'bar', data: <%- JSON.stringify(chartDataWeekdayActivity || {}) %>,
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }
    if (document.getElementById('heatmapChart')) {
        new Chart(document.getElementById('heatmapChart').getContext('2d'), {
            type: 'bar', data: <%- JSON.stringify(chartDataHeatmap || {}) %>,
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }
    if (document.getElementById('funnelChart')) {
        new Chart(document.getElementById('funnelChart').getContext('2d'), {
            type: 'bar', data: <%- JSON.stringify(chartDataFunnel || {}) %>,
            options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } } }
        });
    }
    if (document.getElementById('userFunnelChart')) {
        new Chart(document.getElementById('userFunnelChart').getContext('2d'), {
            type: 'bar', data: <%- JSON.stringify(chartDataUserFunnel || {}) %>,
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }
    if (document.getElementById('retentionChart')) {
        new Chart(document.getElementById('retentionChart').getContext('2d'), {
            type: 'line', data: <%- JSON.stringify(chartDataRetention || {}) %>,
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }
  });
</script>