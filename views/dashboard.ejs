<%# views/dashboard.ejs %>
<% title = '–ê–¥–º–∏–Ω–∫–∞'; page = 'dashboard'; %>

<!-- ... (–≤–µ—Å—å HTML –¥–æ –±–ª–æ–∫–∞ <script> –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... -->
<section class="content-header">
  <div class="container-fluid d-flex justify-content-between align-items-center mb-3">
    <h1>üìä –ê–¥–º–∏–Ω–∫–∞</h1>
    <small>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <%= user ? (user.username || user.first_name) : '–ì–æ—Å—Ç—å' %></small>
  </div>
</section>

<form id="filtersForm" class="mb-3 d-flex gap-2 align-items-center flex-wrap">
  <label for="periodSelectMain" class="form-label mb-0">–ü–µ—Ä–∏–æ–¥:</label>
  <select id="periodSelectMain" name="period" class="form-select form-select-sm" style="width: auto;">
    <option value="7" <%= period === '7' ? 'selected' : '' %>>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
    <option value="30" <%= period === '30' ? 'selected' : '' %>>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
    <% lastMonths.forEach(m => { %>
      <option value="<%= m.value %>" <%= period === m.value ? 'selected' : '' %>><%= m.label %></option>
    <% }) %>
    <option value="all" <%= period === 'all' ? 'selected' : '' %>>–í–µ—Å—å –ø–µ—Ä–∏–æ–¥</option>
  </select>
  
  <div class="form-check ms-3">
    <input class="form-check-input" type="checkbox" id="showInactive" name="showInactive" value="true" <%= showInactive ? 'checked' : '' %>>
    <label class="form-check-label" for="showInactive">–ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö</label>
  </div>

  <a href="/export" id="exportLink" class="btn btn-outline-secondary ms-2">–í—ã–≥—Ä—É–∑–∏—Ç—å CSV</a>
</form>

<section class="content">
  <div class="container-fluid">
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="stats-tab" data-bs-toggle="tab" data-bs-target="#statsTab" type="button" role="tab">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#usersTab" type="button" role="tab">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="broadcast-tab" data-bs-toggle="tab" data-bs-target="#broadcastTab" type="button" role="tab">–†–∞—Å—Å—ã–ª–∫–∞</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analyticsTab" type="button" role="tab">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
      </li>
    </ul>

    <div class="tab-content mt-3" id="dashboardTabsContent">
      <div class="tab-pane fade show active" id="statsTab" role="tabpanel">
        <div class="row mb-3">
            <div class="col-md-6"><div class="info-box bg-primary shadow-sm"><span class="info-box-icon"><i class="fas fa-cogs"></i></span><div class="info-box-content"><span class="info-box-text">–ó–∞–¥–∞—á –≤ —Ä–∞–±–æ—Ç–µ</span><span class="info-box-number" id="queueActive">...</span></div></div></div>
            <div class="col-md-6"><div class="info-box bg-secondary shadow-sm"><span class="info-box-icon"><i class="fas fa-hourglass-half"></i></span><div class="info-box-content"><span class="info-box-text">–ó–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥–∏</span><span class="info-box-number" id="queueSize">...</span></div></div></div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4"><div class="info-box bg-info"><span class="info-box-icon"><i class="fas fa-users"></i></span><div class="info-box-content"><span class="info-box-text">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span><span class="info-box-number" data-stat="totalUsers"><%= stats.totalUsers %></span></div></div></div>
          <div class="col-md-4"><div class="info-box bg-success"><span class="info-box-icon"><i class="fas fa-download"></i></span><div class="info-box-content"><span class="info-box-text">–í—Å–µ–≥–æ –∑–∞–≥—Ä—É–∑–æ–∫</span><span class="info-box-number" data-stat="totalDownloads"><%= stats.totalDownloads %></span></div></div></div>
          <div class="col-md-4"><div class="info-box bg-warning"><span class="info-box-icon"><i class="fas fa-star"></i></span><div class="info-box-content"><span class="info-box-text">–¢–∞—Ä–∏—Ñ—ã (F/P/P/U)</span><span class="info-box-number" data-stat="tariffs"><%= stats.free %>/<%= stats.plus %>/<%= stats.pro %>/<%= stats.unlimited %></span></div></div></div>
        </div>
        <div class="card card-primary card-outline"><div class="card-header"><h3 class="card-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –ó–∞–≥—Ä—É–∑–∫–∏, –ê–∫—Ç–∏–≤–Ω—ã–µ</h3></div><div class="card-body"><canvas id="combinedChart" style="height: 250px;"></canvas></div></div>
        <div class="row mt-3">
          <div class="col-md-6"><div class="card card-info card-outline"><div class="card-header"><h3 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º</h3></div><div class="card-body"><canvas id="hourActivityChart" style="height: 250px;"></canvas></div></div></div>
          <div class="col-md-6"><div class="card card-info card-outline"><div class="card-header"><h3 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</h3></div><div class="card-body"><canvas id="weekdayActivityChart" style="height: 250px;"></canvas></div></div></div>
        </div>
      </div>
      <div class="tab-pane fade" id="usersTab" role="tabpanel">
        <div class="table-responsive"><table id="usersTable" class="table table-bordered table-hover w-100 text-nowrap"><thead><tr><th>ID</th><th>Username</th><th>–ò–º—è</th><th>–°–∫–∞—á–∞–Ω–æ</th><th>–õ–∏–º–∏—Ç</th><th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th><th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ò—Å—Ç–æ—á–Ω–∏–∫</th><th>–¢–∞—Ä–∏—Ñ</th><th>1+1</th><th>–°–±—Ä–æ—Å</th></tr></thead><tbody></tbody></table></div>
      </div>
      <div class="tab-pane fade" id="broadcastTab" role="tabpanel"><%- include('partials/_broadcast-form') %></div>
      <div class="tab-pane fade" id="analyticsTab" role="tabpanel">
        <div class="card"><div class="card-header"><h3 class="card-title">–í–æ—Ä–æ–Ω–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3></div><div class="card-body"><canvas id="funnelChart" style="height: 200px;"></canvas></div></div>
        <div class="card card-danger card-outline mt-3"><div class="card-header"><h3 class="card-title">–ò—Å—Ç–µ–∫–∞—é—â–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ (<%= expiringCount %>)</h3></div><div class="card-body p-0"><%- include('partials/_expiring-users', { expiringSoon, expiringLimit, expiringOffset, expiringCount }) %></div></div>
        <div class="card card-light card-outline mt-3"><div class="card-header"><h3 class="card-title">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞</h3></div><div class="card-body p-0"><%- include('partials/_referral-stats', { referralStats }) %></div></div>
      </div>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    let charts = {};
    const usersTable = new DataTable('#usersTable', {
        paging: true, searching: true, ordering: true, order: [[5, 'desc']], scrollX: true,
        language: { url: 'https://cdn.datatables.net/plug-ins/1.10.25/i18n/Russian.json' }
    });

    function initializeOrUpdateChart(id, type, data, options) {
        const ctx = document.getElementById(id)?.getContext('2d');
        if (!ctx) return;
        if (charts[id]) charts[id].destroy();
        charts[id] = new Chart(ctx, { type, data, options });
    }
    
    // <<< –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ >>>
    function renderUserRow(user) {
        const registrationDate = user.created_at ? new Date(user.created_at).toLocaleDateString() : '-';
        const lastActiveDate = user.last_active ? new Date(user.last_active).toLocaleDateString() : '-';
        const isNew = user.created_at && (new Date(user.created_at).getTime() > Date.now() - 86400000);
        let statusIcon = user.active ? (user.last_active && new Date(user.last_active) > Date.now() - 86400000 ? 'üü¢' : 'üü°') : 'üî¥';
        
        // HTML-–∫–æ–¥ —Ñ–æ—Ä–º—ã –æ–±–µ—Ä–Ω—É—Ç –≤ –æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ (`), —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
        const tariffForm = `
            <form method="POST" action="/set-tariff" class="d-flex align-items-center gap-1 m-0">
                <input type="hidden" name="userId" value="${user.id}">
                <select name="limit" class="form-select form-select-sm" style="min-width: 80px;">
                    <option value="5" ${user.premium_limit <= 5 ? 'selected' : ''}>Free</option>
                    <option value="30" ${user.premium_limit === 30 ? 'selected' : ''}>Plus</option>
                    <option value="100" ${user.premium_limit === 100 ? 'selected' : ''}>Pro</option>
                    <option value="1000" ${user.premium_limit >= 1000 ? 'selected' : ''}>Unlim</option>
                </select>
                <input type="number" name="days" value="30" class="form-control form-control-sm" style="width: 60px;">
                <button type="submit" class="btn btn-primary btn-sm">‚úîÔ∏è</button>
            </form>`;
        
        return [
            `<a href="/user/${user.id}">${user.id}</a>`,
            user.username ? `@${user.username}` : '',
            `${user.first_name || ''} ${isNew ? '<span class="badge bg-info text-dark">üÜï</span>' : ''}`,
            user.total_downloads || 0,
            user.premium_limit,
            registrationDate,
            lastActiveDate,
            statusIcon,
            user.referral_source ? String(user.referral_source).replace(/</g, "&lt;") : '‚Äî',
            tariffForm,
            user.promo_1plus1_used ? '‚úÖ' : '‚ùå',
            `<form action="/admin/reset-promo/${user.id}" method="POST" onsubmit="return confirm('–°–±—Ä–æ—Å–∏—Ç—å?')"><button class="btn btn-sm btn-warning">üîÑ</button></form>`
        ];
    }
    // <<< –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø >>>

    const filtersForm = document.getElementById('filtersForm');

    async function updateDashboardData() { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ }
    async function updateUsersTable() { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ }

    // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    updateDashboardData();
    updateUsersTable();
    filtersForm.addEventListener('change', () => {
        updateDashboardData();
        updateUsersTable();
    });

    // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–∏
    const queueActiveEl = document.getElementById('queueActive');
    const queueSizeEl = document.getElementById('queueSize');
    async function updateQueueStatus() { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ }
    updateQueueStatus();
    setInterval(updateQueueStatus, 5000);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ—Ä–æ–Ω–∫–∏
    const funnelCtx = document.getElementById('funnelChart')?.getContext('2d');
    if (funnelCtx) {
        const funnelData = <%- JSON.stringify(funnelData) %>;
        initializeOrUpdateChart('funnelChart', 'bar', {
            labels: ['–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', '–ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞', '–ü–æ–¥–ø–∏—Å–∫–∞'],
            datasets: [{
                label: '–í–æ—Ä–æ–Ω–∫–∞',
                data: [funnelData.registrationCount, funnelData.firstDownloadCount, funnelData.subscriptionCount],
                backgroundColor: ['#36A2EB', '#FFCE56', '#FF6384']
            }]
        }, { indexAxis: 'y', responsive: true });
    }
  });
</script>