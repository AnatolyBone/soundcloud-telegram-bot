<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h3 { margin-bottom: 10px; }
    .chart-container { width: 100%; max-width: 900px; margin-bottom: 40px; height: 200px; }
    .inactive { color: #aaa; }
  </style>
</head>
<body>
  <h1>üìä Admin Dashboard</h1>

  <form method="GET" action="/dashboard" style="margin-bottom: 20px;">
    <label><input type="checkbox" name="showInactive" value="true" <%= showInactive ? 'checked' : '' %>> –ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö</label>
    <button type="submit">–û–±–Ω–æ–≤–∏—Ç—å</button>
    <a href="/export" style="margin-left: 20px;">üìÅ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</a>
  </form>

  <% if (showInactive) { %>
    <form method="POST" action="/delete-inactive">
      <button type="submit" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?')">üóë –£–¥–∞–ª–∏—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö</button>
    </form>
  <% } %>

  <p><strong>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</strong> <%= stats.totalUsers %></p>
  <p><strong>–ó–∞–≥—Ä—É–∑–æ–∫:</strong> <%= stats.totalDownloads %></p>
  <p><strong>–¢–∞—Ä–∏—Ñ—ã:</strong> Free: <%= stats.free %>, Plus: <%= stats.plus %>, Pro: <%= stats.pro %>, Unlim: <%= stats.unlimited %></p>

  <div class="chart-container"><canvas id="combinedChart"></canvas></div>

  <h3>üïí –° —Ç–∞—Ä–∏—Ñ–æ–º, –∏—Å—Ç–µ–∫–∞—é—â–∏–º –≤ –±–ª–∏–∂–∞–π—à–∏–µ 3 –¥–Ω—è</h3>
  <% if (expiringSoon.length === 0) { %>
    <p>–ù–µ—Ç —Ç–∞–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
  <% } else { %>
    <ul>
      <% expiringSoon.forEach(u => { %>
        <li><%= u.first_name %> (<%= u.username ? '@' + u.username : '‚Äî' %>) ‚Äî –¥–æ <%= new Date(u.premium_until).toLocaleDateString() %></li>
      <% }) %>
    </ul>
  <% } %>
  
  <h3>üìà –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞</h3>
  <table>
    <thead>
      <tr><th>–ò—Å—Ç–æ—á–Ω–∏–∫</th><th>–ö–æ–ª-–≤–æ</th></tr>
    </thead>
    <tbody>
      <% referralStats.forEach(source => { %>
        <tr>
          <td><%= source.referral_source || '‚Äî' %></td>
          <td><%= source.count %></td>
        </tr>
      <% }) %>
    </tbody>
  </table>
  
  <h3>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (<%= users.length %>)</h3>
  <table id="usersTable" class="display">
    <thead>
      <tr>
        <th>ID</th><th>Username</th><th>–ò–º—è</th><th>–°–∫–∞—á–∞–Ω–æ</th><th>–õ–∏–º–∏—Ç</th>
        <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th><th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ò—Å—Ç–æ—á–Ω–∏–∫</th><th>–¢–∞—Ä–∏—Ñ</th>
      </tr>
    </thead>
    <tbody>
      <% users.forEach(user => { %>
        <tr class="<%= !user.active ? 'inactive' : '' %>">
          <td><%= user.id %></td>
          <td><%= user.username ? '@' + user.username : '' %></td>
          <td>
            <%= user.first_name %> 
            <% if (new Date(user.created_at) > Date.now() - 24 * 60 * 60 * 1000) { %>üÜï<% } %>
          </td>
          <td><%= user.total_downloads || 0 %></td>
          <td><%= user.premium_limit %></td>
          <td><%= user.created_at ? new Date(user.created_at).toLocaleDateString() : '-' %></td>
          <td><%= user.last_active ? new Date(user.last_active).toLocaleDateString() : '-' %></td>
          <td>
            <% if (!user.last_active) { %>üî¥
            <% } else if (new Date(user.last_active) > Date.now() - 24 * 60 * 60 * 1000) { %>üü¢
            <% } else { %>üü°<% } %>
          </td>
          <td><%= user.referral_source || '‚Äî' %></td>
          <td>
            <form method="POST" action="/set-tariff" style="margin:0;">
              <input type="hidden" name="userId" value="<%= user.id %>">
              <select name="limit">
                <option value="10" <%= user.premium_limit === 10 ? 'selected' : '' %>>Free</option>
                <option value="50" <%= user.premium_limit === 50 ? 'selected' : '' %>>Plus</option>
                <option value="100" <%= user.premium_limit === 100 ? 'selected' : '' %>>Pro</option>
                <option value="1000" <%= user.premium_limit >= 1000 ? 'selected' : '' %>>Unlimited</option>
              </select>
              <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>

  <h3>üì¢ –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</h3>
  <form method="POST" action="/broadcast" enctype="multipart/form-data">
    <textarea name="message" rows="4" cols="60" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç" required></textarea><br>
    <input type="file" name="audio"><br>
    <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </form>

  <script>
    $(document).ready(() => {
      $('#usersTable').DataTable({
        order: [[5, 'desc']],
        language: {
          search: "–ü–æ–∏—Å–∫:",
          lengthMenu: "–ü–æ–∫–∞–∑–∞—Ç—å _MENU_ –∑–∞–ø–∏—Å–µ–π",
          info: "–ü–æ–∫–∞–∑–∞–Ω–æ _START_ - _END_ –∏–∑ _TOTAL_",
          paginate: {
            first: "–ü–µ—Ä–≤–∞—è", last: "–ü–æ—Å–ª–µ–¥–Ω—è—è", next: "–°–ª–µ–¥—É—é—â–∞—è", previous: "–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
          },
          zeroRecords: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
        }
      });
    });

    const combinedLabels = <%- JSON.stringify(Object.keys(stats.registrationsByDate)) %>;
    const registrationsData = <%- JSON.stringify(Object.values(stats.registrationsByDate)) %>;
    const downloadsData = <%- JSON.stringify(Object.values(stats.downloadsByDate)) %>;
    const activeUsersData = <%- JSON.stringify(Object.values(stats.activeByDate)) %>;

    new Chart(document.getElementById('combinedChart'), {
      type: 'line',
      data: {
        labels: combinedLabels,
        datasets: [
          {
            label: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏',
            data: registrationsData,
            borderColor: 'blue',
            backgroundColor: 'lightblue',
            fill: false,
            tension: 0.3,
          },
          {
            label: '–ó–∞–≥—Ä—É–∑–∫–∏',
            data: downloadsData,
            borderColor: 'green',
            backgroundColor: 'lightgreen',
            fill: false,
            tension: 0.3,
          },
          {
            label: '–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
            data: activeUsersData,
            borderColor: 'orange',
            backgroundColor: 'moccasin',
            fill: false,
            tension: 0.3,
          }
        ]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        stacked: false,
        scales: {
          y: {
            beginAtZero: true,
          }
        }
      }
    });
  </script>
</body>
</html>