<% title = '–ê–¥–º–∏–Ω–∫–∞'; page = 'dashboard'; %>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
  <link href="/static/css/admin.css" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="container-fluid p-3">

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <section class="content-header">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>üìä –ê–¥–º–∏–Ω–∫–∞</h1>
        <small>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <%= user ? (user.username || user.first_name) : '–ì–æ—Å—Ç—å' %></small>
      </div>
    </section>

    <!-- –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞ -->
    <form method="get" action="/dashboard" class="mb-3 d-flex gap-2 align-items-center flex-wrap">
      <label for="periodSelectMain" class="form-label mb-0">–ü–µ—Ä–∏–æ–¥:</label>
      <select id="periodSelectMain" name="period" class="form-select form-select-sm" style="width: auto;" onchange="this.form.submit()">
        <option value="7" <%= period === '7' ? 'selected' : '' %>>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
        <option value="30" <%= period === '30' ? 'selected' : '' %>>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
        <% lastMonths.forEach(m => { %>
          <option value="<%= m.value %>" <%= period === m.value ? 'selected' : '' %>><%= m.label %></option>
        <% }) %>
        <option value="all" <%= period === 'all' ? 'selected' : '' %>>–í–µ—Å—å –ø–µ—Ä–∏–æ–¥</option>
      </select>
      <a href="/export?period=<%= encodeURIComponent(period) %>" class="btn btn-outline-secondary ms-2">–í—ã–≥—Ä—É–∑–∏—Ç—å CSV</a>
    </form>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <section class="content">
      <div class="container-fluid">

        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab" aria-controls="stats" aria-selected="true">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#usersTab" type="button" role="tab" aria-controls="usersTab" aria-selected="false">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="broadcast-tab" data-bs-toggle="tab" data-bs-target="#broadcastTab" type="button" role="tab" aria-controls="broadcastTab" aria-selected="false">–†–∞—Å—Å—ã–ª–∫–∞</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analyticsTab" type="button" role="tab" aria-controls="analyticsTab" aria-selected="false">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="retention-tab" data-bs-toggle="tab" data-bs-target="#retentionTab" type="button" role="tab" aria-controls="retentionTab" aria-selected="false">–£–¥–µ—Ä–∂–∞–Ω–∏–µ –∏ –í–æ—Ä–æ–Ω–∫–∞</button>
          </li>
        </ul>

        <div class="tab-content mt-3" id="dashboardTabsContent">

          <!-- –í–∫–ª–∞–¥–∫–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
          <div class="tab-pane fade show active" id="stats" role="tabpanel" aria-labelledby="stats-tab">

            <!-- –ó–¥–µ—Å—å –≤–µ—Å—å –∫–æ–¥ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" -->

          </div>

          <!-- –í–∫–ª–∞–¥–∫–∞ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
          <div class="tab-pane fade" id="usersTab" role="tabpanel" aria-labelledby="users-tab">

            <!-- –ó–¥–µ—Å—å –≤–µ—Å—å –∫–æ–¥ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏" -->

          </div>

          <!-- –í–∫–ª–∞–¥–∫–∞ –†–∞—Å—Å—ã–ª–∫–∞ -->
          <div class="tab-pane fade" id="broadcastTab" role="tabpanel" aria-labelledby="broadcast-tab">

            <!-- –í–∫–ª–∞–¥–∫–∞ –†–∞—Å—Å—ã–ª–∫–∞ -->
      <div class="tab-pane fade" id="broadcastTab" role="tabpanel" aria-labelledby="broadcast-tab">
        <form method="POST" action="/broadcast" enctype="multipart/form-data" class="mb-3" novalidate>
          <div class="mb-3">
            <label for="broadcastMessage" class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
            <textarea id="broadcastMessage" name="message" class="form-control" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç"></textarea>
          </div>
          <div class="mb-3">
            <label for="broadcastAudio" class="form-label">–ê—É–¥–∏–æ—Ñ–∞–π–ª (mp3)</label>
            <input type="file" id="broadcastAudio" name="audio" accept="audio/mpeg" class="form-control" />
          </div>
          <button type="submit" class="btn btn-success">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</button>
        </form>
      </div>

          <!-- –í–∫–ª–∞–¥–∫–∞ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
      <div class="tab-pane fade" id="analyticsTab" role="tabpanel" aria-labelledby="analytics-tab">

        <div class="card card-primary card-outline">
          <div class="card-header">
            <h3 class="card-title">–í–æ—Ä–æ–Ω–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
          </div>
          <div class="card-body">
            <canvas id="funnelChart" style="height: 200px;"></canvas>
          </div>
        </div>

        <div class="card card-secondary card-outline mt-3">
          <div class="card-header">
            <h3 class="card-title">User Funnel</h3>
          </div>
          <div class="card-body">
            <canvas id="userFunnelChart" style="height: 200px;"></canvas>
          </div>
        </div>

      </div>
          <div class="tab-pane fade" id="analyticsTab" role="tabpanel" aria-labelledby="analytics-tab">


          <!-- –í–∫–ª–∞–¥–∫–∞ –£–¥–µ—Ä–∂–∞–Ω–∏–µ –∏ –í–æ—Ä–æ–Ω–∫–∞ -->
      <div class="tab-pane fade" id="retentionTab" role="tabpanel" aria-labelledby="retention-tab">

        <div class="card card-info card-outline">
          <div class="card-header">
            <h3 class="card-title">Retention</h3>
          </div>
          <div class="card-body">
            <canvas id="retentionChart" style="height: 300px;"></canvas>
          </div>
        </div>

      </div>
          <div class="tab-pane fade" id="retentionTab" role="tabpanel" aria-labelledby="retention-tab">

            <!-- –ó–¥–µ—Å—å –≤–µ—Å—å –∫–æ–¥ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–£–¥–µ—Ä–∂–∞–Ω–∏–µ –∏ –í–æ—Ä–æ–Ω–∫–∞" -->

          </div>

        </div>
      </div>
    </section>
  </div>

  <!-- –°–∫—Ä–∏–ø—Ç—ã -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <script>
    $(document).ready(function() {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DataTables –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Ç—É—Ç
    });
  </script>
</body>
</html>