<% title = '–ê–¥–º–∏–Ω–∫–∞'; page = 'dashboard'; %>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<section class="content-header">
  <div class="container-fluid d-flex justify-content-between align-items-center mb-3">
    <h1>üìä –ê–¥–º–∏–Ω–∫–∞</h1>
    <small>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <%= user ? (user.username || user.first_name) : '–ì–æ—Å—Ç—å' %></small>
  </div>
</section>

<!-- –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è) -->
<form method="get" action="/dashboard" class="mb-3 d-flex gap-2 align-items-center flex-wrap">
  <label for="periodSelectMain" class="form-label mb-0">–ü–µ—Ä–∏–æ–¥:</label>
  <select id="periodSelectMain" name="period" class="form-select form-select-sm" style="width: auto;" onchange="this.form.submit()">
    <option value="7" <%= period === '7' ? 'selected' : '' %>>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
    <option value="30" <%= period === '30' ? 'selected' : '' %>>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
    <% lastMonths.forEach(m => { %>
      <option value="<%= m.value %>" <%= period === m.value ? 'selected' : '' %>><%= m.label %></option>
    <% }) %>
    <option value="all" <%= period === 'all' ? 'selected' : '' %>>–í–µ—Å—å –ø–µ—Ä–∏–æ–¥</option>
  </select>
  <a href="/export?period=<%= encodeURIComponent(period) %>" class="btn btn-outline-secondary ms-2">–í—ã–≥—Ä—É–∑–∏—Ç—å CSV</a>
</form>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
<section class="content">
  <div class="container-fluid">

    <!-- –í–∫–ª–∞–¥–∫–∏ -->
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
      <!-- ... –≤–∫–ª–∞–¥–∫–∏ ... -->
    </ul>

    <div class="tab-content mt-3" id="dashboardTabsContent">

      <!-- –í–∫–ª–∞–¥–∫–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="tab-pane fade show active" id="stats" role="tabpanel" aria-labelledby="stats-tab">

        <!-- ... –¥—Ä—É–≥–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ... -->

        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="card card-primary card-outline">
          <div class="card-header">
            <h3 class="card-title">–ó–∞–≥—Ä—É–∑–∫–∏ (–Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫)</h3> <!-- *** -->
          </div>
          <div class="card-body">
            <canvas id="downloadsChart" style="height: 250px;"></canvas> <!-- *** -->
          </div>
        </div>

        <div class="card card-primary card-outline mt-3">
          <div class="card-header">
            <h3 class="card-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –ó–∞–≥—Ä—É–∑–∫–∏, –ê–∫—Ç–∏–≤–Ω—ã–µ</h3>
          </div>
          <div class="card-body">
            <canvas id="combinedChart" style="height: 250px;"></canvas>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-6">
            <div class="card card-info card-outline">
              <div class="card-header">
                <h3 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º</h3>
              </div>
              <div class="card-body">
                <canvas id="hourActivityChart" style="height: 250px;"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card card-info card-outline">
              <div class="card-header">
                <h3 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</h3>
              </div>
              <div class="card-body">
                <canvas id="weekdayActivityChart" style="height: 250px;"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç ... -->

      </div>

      <!-- ... –¥—Ä—É–≥–∏–µ –≤–∫–ª–∞–¥–∫–∏ ... -->

    </div>

  </div>
</section>

<!-- –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ DataTables -->
<script src="/static/js/chart.min.js"></script>
<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/datatables.min.js"></script>

<script>
  $(document).ready(function() {
    $('#usersTable').DataTable({
      paging: true,
      searching: true,
      ordering: true,
      order: [[0, 'desc']],
      scrollX: true,
      language: {
        url: '/static/js/datatables-ru.json'
      }
    });

    // *** –ù–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫ –ó–∞–≥—Ä—É–∑–æ–∫ ***
    const downloadsCtx = document.getElementById('downloadsChart').getContext('2d');
    const downloadsChart = new Chart(downloadsCtx, {
      type: 'line',
      data: <%- JSON.stringify(chartDataDownloads || {}) %>,
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          tooltip: { enabled: true }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    // –ì—Ä–∞—Ñ–∏–∫: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –ó–∞–≥—Ä—É–∑–∫–∏, –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (combinedChart)
    const combinedCtx = document.getElementById('combinedChart').getContext('2d');
    const combinedChart = new Chart(combinedCtx, {
      type: 'line',
      data: <%- JSON.stringify(chartDataCombined || {}) %>,
      options: {
        responsive: true,
        plugins: { legend: { position: 'top' } },
        scales: { y: { beginAtZero: true } }
      }
    });

    // –ì—Ä–∞—Ñ–∏–∫: –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º
    const hourCtx = document.getElementById('hourActivityChart').getContext('2d');
    const hourActivityChart = new Chart(hourCtx, {
      type: 'bar',
      data: <%- JSON.stringify(chartDataHourActivity || {}) %>,
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

    // –ì—Ä–∞—Ñ–∏–∫: –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏
    const weekdayCtx = document.getElementById('weekdayActivityChart').getContext('2d');
    const weekdayActivityChart = new Chart(weekdayCtx, {
      type: 'bar',
      data: <%- JSON.stringify(chartDataWeekdayActivity || {}) %>,
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

    // –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞
    const heatmapCtx = document.getElementById('heatmapChart').getContext('2d');
    const heatmapChart = new Chart(heatmapCtx, {
      type: 'bar',
      data: <%- JSON.stringify(chartDataHeatmap || {}) %>,
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

    // –í–æ—Ä–æ–Ω–∫–∞
    const funnelCtx = document.getElementById('funnelChart').getContext('2d');
    const funnelChart = new Chart(funnelCtx, {
      type: 'bar',
      data: <%- JSON.stringify(chartDataFunnel || {}) %>,
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

    // Retention
    const retentionCtx = document.getElementById('retentionChart').getContext('2d');
    const retentionChart = new Chart(retentionCtx, {
      type: 'line',
      data: <%- JSON.stringify(chartDataRetention || {}) %>,
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

    // User funnel
    const userFunnelCtx = document.getElementById('userFunnelChart').getContext('2d');
    const userFunnelChart = new Chart(userFunnelCtx, {
      type: 'bar',
      data: <%- JSON.stringify(chartDataUserFunnel || {}) %>,
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

    // –§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    window.changePage = function(dir) {
      const url = new URL(window.location.href);
      let offset = parseInt(url.searchParams.get('expiringOffset')) || 0;
      offset += dir * <%= expiringLimit %>;
      if (offset < 0) offset = 0;
      url.searchParams.set('expiringOffset', offset);
      window.location.href = url.toString();
    };
  });
</script>