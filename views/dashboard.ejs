<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>

  <!-- AdminLTE -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
</head>
<body class="hold-transition sidebar-mini dark-mode">
<div class="wrapper">
  <div class="content-wrapper p-4">
    <div class="container-fluid">

      <div class="mb-4">
        <h1 class="m-0 text-white"><i class="fas fa-chart-line"></i> –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
      </div>

      <div class="row mb-4">
        <div class="col-md-3 col-sm-6">
          <div class="small-box bg-info">
            <div class="inner">
              <h3><%= stats.totalUsers %></h3>
              <p>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
            </div>
            <div class="icon">
              <i class="fas fa-users"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="small-box bg-success">
            <div class="inner">
              <h3><%= stats.totalDownloads %></h3>
              <p>–ó–∞–≥—Ä—É–∑–æ–∫</p>
            </div>
            <div class="icon">
              <i class="fas fa-download"></i>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-sm-12">
          <div class="card bg-dark">
            <div class="card-header">
              <h3 class="card-title">–¢–∞—Ä–∏—Ñ—ã</h3>
            </div>
            <div class="card-body">
              Free: <%= stats.free %>, Plus: <%= stats.plus %>, Pro: <%= stats.pro %>, Unlim: <%= stats.unlimited %>
            </div>
          </div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
      <div class="row">
        <div class="col-md-6">
          <div class="card card-dark">
            <div class="card-header">
              <h3 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å / —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ / –∑–∞–≥—Ä—É–∑–∫–∏</h3>
            </div>
            <div class="card-body">
              <canvas id="combinedChart"></canvas>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card card-dark">
            <div class="card-header">
              <h3 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º</h3>
            </div>
            <div class="card-body">
              <canvas id="hourActivityChart"></canvas>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card card-dark">
            <div class="card-header">
              <h3 class="card-title">–ü–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</h3>
            </div>
            <div class="card-body">
              <canvas id="weekdayActivityChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <!-- –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ -->
      <div class="card card-dark">
        <div class="card-header">
          <h3 class="card-title">üóì –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
        </div>
        <div class="card-body">
          <canvas id="heatmapChart" style="height:400px;"></canvas>
        </div>
      </div>

      <!-- –ò—Å—Ç–µ–∫–∞—é—â–∏–µ —Ç–∞—Ä–∏—Ñ—ã -->
      <div class="card card-dark">
        <div class="card-header">
          <h3 class="card-title">üïí –ò—Å—Ç–µ–∫–∞—é—â–∏–µ —Ç–∞—Ä–∏—Ñ—ã</h3>
        </div>
        <div class="card-body">
          <% if (expiringSoon.length === 0) { %>
            <p>–ù–µ—Ç —Ç–∞–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
          <% } else { %>
            <ul>
              <% expiringSoon.forEach(u => { %>
                <li><%= u.first_name %> (<%= u.username ? '@' + u.username : '‚Äî' %>) ‚Äî –¥–æ <%= new Date(u.premium_until).toLocaleDateString() %></li>
              <% }) %>
            </ul>
          <% } %>
        </div>
      </div>

      <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
      <div class="card card-dark">
        <div class="card-header">
          <h3 class="card-title">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
        </div>
        <div class="card-body">
          <table id="usersTable" class="table table-bordered table-striped">
            <thead>
              <tr>
                <th>ID</th><th>Username</th><th>–ò–º—è</th><th>–°–∫–∞—á–∞–Ω–æ</th><th>–õ–∏–º–∏—Ç</th>
                <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th><th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th><th>üü¢/üü°/üî¥</th><th>–ò—Å—Ç–æ—á–Ω–∏–∫</th><th>–¢–∞—Ä–∏—Ñ</th>
              </tr>
            </thead>
            <tbody>
              <% users.forEach(user => { %>
                <tr class="<%= !user.active ? 'text-muted' : '' %>">
                  <td><%= user.id %></td>
                  <td><%= user.username ? '@' + user.username : '' %></td>
                  <td>
                    <%= user.first_name %> 
                    <% if (new Date(user.created_at) > Date.now() - 24 * 60 * 60 * 1000) { %>üÜï<% } %>
                  </td>
                  <td><%= user.total_downloads || 0 %></td>
                  <td><%= user.premium_limit %></td>
                  <td><%= user.created_at ? new Date(user.created_at).toLocaleDateString() : '-' %></td>
                  <td><%= user.last_active ? new Date(user.last_active).toLocaleDateString() : '-' %></td>
                  <td>
                    <% if (!user.last_active) { %>üî¥
                    <% } else if (new Date(user.last_active) > Date.now() - 24 * 60 * 60 * 1000) { %>üü¢
                    <% } else { %>üü°<% } %>
                  </td>
                  <td><%= user.referral_source || '‚Äî' %></td>
                  <td>
                    <form method="POST" action="/set-tariff" style="margin:0;">
                      <input type="hidden" name="userId" value="<%= user.id %>">
                      <select name="limit" class="form-control form-control-sm">
                        <option value="10" <%= user.premium_limit === 10 ? 'selected' : '' %>>Free</option>
                        <option value="50" <%= user.premium_limit === 50 ? 'selected' : '' %>>Plus</option>
                        <option value="100" <%= user.premium_limit === 100 ? 'selected' : '' %>>Pro</option>
                        <option value="1000" <%= user.premium_limit >= 1000 ? 'selected' : '' %>>Unlimited</option>
                      </select>
                      <button type="submit" class="btn btn-sm btn-primary mt-1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ -->
      <div class="card card-dark">
        <div class="card-header">
          <h3 class="card-title">üì¢ –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</h3>
        </div>
        <div class="card-body">
          <form method="POST" action="/broadcast" enctype="multipart/form-data">
            <div class="form-group">
              <textarea name="message" rows="4" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..." required></textarea>
            </div>
            <div class="form-group">
              <label>–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∞—É–¥–∏–æ:</label>
              <input type="file" name="audio" class="form-control-file">
            </div>
            <button type="submit" class="btn btn-success">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </form>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- JS –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
<script>
  const labels = <%- JSON.stringify(Object.keys(stats.registrationsByDate)) %>;
  const regData = <%- JSON.stringify(Object.values(stats.registrationsByDate)) %>;
  const downloads = <%- JSON.stringify(Object.values(stats.downloadsByDate)) %>;
  const active = <%- JSON.stringify(Object.values(stats.activeByDate)) %>;

  new Chart(document.getElementById('combinedChart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', data: regData, borderColor: 'blue', fill: false },
        { label: '–ó–∞–≥—Ä—É–∑–∫–∏', data: downloads, borderColor: 'green', fill: false },
        { label: '–ê–∫—Ç–∏–≤–Ω—ã–µ', data: active, borderColor: 'orange', fill: false }
      ]
    }
  });

  const hoursLabels = Array.from({length:24}, (_,i) => i + ':00');
  const activityByHour = <%- JSON.stringify(stats.activityByHour || Array(24).fill(0)) %>;
  new Chart(document.getElementById('hourActivityChart'), {
    type: 'bar',
    data: { labels: hoursLabels, datasets: [{ label: '–ü–æ —á–∞—Å–∞–º', data: activityByHour, backgroundColor: 'teal' }] }
  });

  const weekdaysLabels = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
  const activityByWeekday = <%- JSON.stringify(stats.activityByWeekday || Array(7).fill(0)) %>;
  new Chart(document.getElementById('weekdayActivityChart'), {
    type: 'bar',
    data: { labels: weekdaysLabels, datasets: [{ label: '–ü–æ –¥–Ω—è–º', data: activityByWeekday, backgroundColor: 'purple' }] }
  });

  const activityByDayHour = <%- JSON.stringify(stats.activityByDayHour || {}) %>;
  const days = Object.keys(activityByDayHour).sort();
  const hours = Array.from({length: 24}, (_, i) => i);
  const heatmapDatasets = hours.map(hour => ({
    label: hour + ':00',
    data: days.map(day => activityByDayHour[day]?.[hour] || 0),
    backgroundColor: ctx => {
      const v = ctx.dataset.data[ctx.dataIndex];
      const a = Math.min(v / 3, 1);
      return `rgba(54, 162, 235, ${a})`;
    },
    borderWidth: 0
  }));
  new Chart(document.getElementById('heatmapChart'), {
    type: 'bar',
    data: { labels: days, datasets: heatmapDatasets },
    options: {
      indexAxis: 'y',
      scales: { x: { stacked: true }, y: { stacked: true } },
      plugins: { legend: { display: false } }
    }
  });

  // DataTables init
  $(document).ready(() => {
    $('#usersTable').DataTable({
      language: {
        search: "–ü–æ–∏—Å–∫:",
        lengthMenu: "–ü–æ–∫–∞–∑–∞—Ç—å _MENU_ –∑–∞–ø–∏—Å–µ–π",
        info: "–ü–æ–∫–∞–∑–∞–Ω–æ _START_ - _END_ –∏–∑ _TOTAL_",
        paginate: {
          first: "–ü–µ—Ä–≤–∞—è", last: "–ü–æ—Å–ª–µ–¥–Ω—è—è", next: "‚Üí", previous: "‚Üê"
        },
        zeroRecords: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
      }
    });
  });
</script>

</body>
</html>