<% title = '–ê–¥–º–∏–Ω–∫–∞'; page = 'dashboard'; %>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<section class="content-header">
  <div class="container-fluid d-flex justify-content-between align-items-center mb-3">
    <h1>üìä –ê–¥–º–∏–Ω–∫–∞</h1>
    <small>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <%= user ? (user.username || user.first_name) : '–ì–æ—Å—Ç—å' %></small>
  </div>
</section>

<!-- –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞ -->
<form id="filtersForm" class="mb-3 d-flex gap-2 align-items-center flex-wrap">
  <label for="periodSelectMain" class="form-label mb-0">–ü–µ—Ä–∏–æ–¥:</label>
  <select id="periodSelectMain" name="period" class="form-select form-select-sm" style="width: auto;">
    <option value="7" <%= period === '7' ? 'selected' : '' %>>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
    <option value="30" <%= period === '30' ? 'selected' : '' %>>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
    <% lastMonths.forEach(m => { %>
      <option value="<%= m.value %>" <%= period === m.value ? 'selected' : '' %>><%= m.label %></option>
    <% }) %>
    <option value="all" <%= period === 'all' ? 'selected' : '' %>>–í–µ—Å—å –ø–µ—Ä–∏–æ–¥</option>
  </select>
  
  <div class="form-check ms-3">
    <input class="form-check-input" type="checkbox" id="showInactive" name="showInactive" value="true" <%= showInactive ? 'checked' : '' %>>
    <label class="form-check-label" for="showInactive">–ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö</label>
  </div>

  <a href="/export?period=<%= encodeURIComponent(period) %>" id="exportLink" class="btn btn-outline-secondary ms-2">–í—ã–≥—Ä—É–∑–∏—Ç—å CSV</a>
</form>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
<section class="content">
  <div class="container-fluid">

    <!-- –í–∫–ª–∞–¥–∫–∏ -->
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab" aria-controls="stats" aria-selected="true">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#usersTab" type="button" role="tab" aria-controls="usersTab" aria-selected="false">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="broadcast-tab" data-bs-toggle="tab" data-bs-target="#broadcastTab" type="button" role="tab" aria-controls="broadcastTab" aria-selected="false">–†–∞—Å—Å—ã–ª–∫–∞</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analyticsTab" type="button" role="tab" aria-controls="analyticsTab" aria-selected="false">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="retention-tab" data-bs-toggle="tab" data-bs-target="#retentionTab" type="button" role="tab" aria-controls="retentionTab" aria-selected="false">–£–¥–µ—Ä–∂–∞–Ω–∏–µ –∏ –í–æ—Ä–æ–Ω–∫–∞</button>
      </li>
    </ul>

    <div class="tab-content mt-3" id="dashboardTabsContent">

      <!-- –í–∫–ª–∞–¥–∫–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="tab-pane fade show active" id="stats" role="tabpanel" aria-labelledby="stats-tab">

        <!-- Real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–∏ -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="info-box bg-primary shadow-sm">
                    <span class="info-box-icon"><i class="fas fa-cogs"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">–ó–∞–¥–∞—á –≤ —Ä–∞–±–æ—Ç–µ</span>
                        <span class="info-box-number" id="queueActive">...</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-box bg-secondary shadow-sm">
                    <span class="info-box-icon"><i class="fas fa-hourglass-half"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">–ó–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥–∏</span>
                        <span class="info-box-number" id="queueSize">...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–ª–∞—à–∫–∏ -->
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="info-box bg-info">
              <span class="info-box-icon"><i class="fas fa-users"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
                <span class="info-box-number" data-stat="totalUsers"><%= stats.totalUsers %></span>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="info-box bg-success">
              <span class="info-box-icon"><i class="fas fa-download"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">–í—Å–µ–≥–æ –∑–∞–≥—Ä—É–∑–æ–∫</span>
                <span class="info-box-number" data-stat="totalDownloads"><%= stats.totalDownloads %></span>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="info-box bg-warning">
              <span class="info-box-icon"><i class="fas fa-star"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">–¢–∞—Ä–∏—Ñ—ã (F/P/P/U)</span>
                <span class="info-box-number" data-stat="tariffs">
                  <%= stats.free %> / <%= stats.plus %> / <%= stats.pro %> / <%= stats.unlimited %>
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="card card-primary card-outline">
          <div class="card-header"><h3 class="card-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –ó–∞–≥—Ä—É–∑–∫–∏, –ê–∫—Ç–∏–≤–Ω—ã–µ</h3></div>
          <div class="card-body"><canvas id="combinedChart" style="height: 250px;"></canvas></div>
        </div>
        <div class="row mt-3">
          <div class="col-md-6">
            <div class="card card-info card-outline">
              <div class="card-header"><h3 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º</h3></div>
              <div class="card-body"><canvas id="hourActivityChart" style="height: 250px;"></canvas></div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card card-info card-outline">
              <div class="card-header"><h3 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</h3></div>
              <div class="card-body"><canvas id="weekdayActivityChart" style="height: 250px;"></canvas></div>
            </div>
          </div>
        </div>
        <div class="card card-secondary card-outline mt-3">
          <div class="card-header"><h3 class="card-title">–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3></div>
          <div class="card-body" style="height: 400px;"><canvas id="heatmapChart"></canvas></div>
        </div>
        <div class="card card-danger card-outline mt-3">
          <div class="card-header"><h3 class="card-title">–ò—Å—Ç–µ–∫–∞—é—â–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ (<%= expiringCount %>)</h3></div>
          <div class="card-body"><%- include('partials/_expiring-users', { expiringSoon, expiringOffset, expiringLimit, expiringCount }) %></div>
        </div>
        <div class="card card-light card-outline mt-3">
          <div class="card-header"><h3 class="card-title">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞</h3></div>
          <div class="card-body p-0"><%- include('partials/_referral-stats', { referralStats }) %></div>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
      <div class="tab-pane fade" id="usersTab" role="tabpanel" aria-labelledby="users-tab">
        <div class="table-responsive">
            <table id="usersTable" class="table table-bordered table-hover w-100 text-nowrap">
              <thead>
                <tr>
                  <th>ID</th><th>Username</th><th>–ò–º—è</th><th>–°–∫–∞—á–∞–Ω–æ</th><th>–õ–∏–º–∏—Ç</th>
                  <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th><th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                  <th>–¢–∞—Ä–∏—Ñ</th><th>1+1</th><th>–°–±—Ä–æ—Å</th>
                </tr>
              </thead>
              <tbody>
                <% users.forEach(user => { %>
                  <tr class="<%= !user.active ? 'table-secondary' : '' %>">
                    <td><a href="/user/<%= user.id %>"><%= user.id %></a></td>
                    <td><%= user.username ? '@' + user.username : '' %></td>
                    <td>
                      <%= user.first_name %>
                      <% if (user.created_at && new Date(user.created_at).getTime() > Date.now() - 86400000) { %>
                        <span class="badge bg-info text-dark">üÜï</span>
                      <% } %>
                    </td>
                    <td><%= user.total_downloads || 0 %></td>
                    <td><%= user.premium_limit %></td>
                    <td><%= user.created_at ? new Date(user.created_at).toLocaleDateString() : '-' %></td>
                    <td><%= user.last_active ? new Date(user.last_active).toLocaleDateString() : '-' %></td>
                    <td>
                      <% if (!user.last_active) { %>üî¥
                      <% } else if (new Date(user.last_active) > Date.now() - 86400000) { %>üü¢
                      <% } else { %>üü°
                      <% } %>
                    </td>
                    <td><%= user.referral_source ? user.referral_source.replace(/</g, "&lt;") : '‚Äî' %></td>
                    <td>
                      <form method="POST" action="/set-tariff" class="d-flex align-items-center gap-2 m-0">
                        <input type="hidden" name="userId" value="<%= user.id %>">
                        <select name="limit" class="form-select form-select-sm">
                          <option value="10" <%= user.premium_limit <= 10 ? 'selected' : '' %>>Free</option>
                          <option value="50" <%= user.premium_limit > 10 && user.premium_limit <= 50 ? 'selected' : '' %>>Plus</option>
                          <option value="100" <%= user.premium_limit > 50 && user.premium_limit < 1000 ? 'selected' : '' %>>Pro</option>
                          <option value="1000" <%= user.premium_limit >= 1000 ? 'selected' : '' %>>Unlimited</option>
                        </select>
                        <button type="submit" class="btn btn-primary btn-sm">‚úîÔ∏è</button>
                      </form>
                    </td>
                    <td><%= user.promo_1plus1_used ? '‚úÖ' : '‚ùå' %></td>
                    <td>
                      <form action="/admin/reset-promo/<%= user.id %>" method="POST" onsubmit="return confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–º–æ —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é?')">
                        <button class="btn btn-sm btn-warning">üîÑ</button>
                      </form>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ –†–∞—Å—Å—ã–ª–∫–∞ -->
      <div class="tab-pane fade" id="broadcastTab" role="tabpanel" aria-labelledby="broadcast-tab">
        <%- include('partials/_broadcast-form') %>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
      <div class="tab-pane fade" id="analyticsTab" role="tabpanel" aria-labelledby="analytics-tab">
        <div class="card card-primary card-outline">
          <div class="card-header"><h3 class="card-title">–í–æ—Ä–æ–Ω–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3></div>
          <div class="card-body"><canvas id="funnelChart" style="height: 200px;"></canvas></div>
        </div>
        <div class="card card-secondary card-outline mt-3">
          <div class="card-header"><h3 class="card-title">User Funnel</h3></div>
          <div class="card-body"><canvas id="userFunnelChart" style="height: 200px;"></canvas></div>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ –£–¥–µ—Ä–∂–∞–Ω–∏–µ –∏ –í–æ—Ä–æ–Ω–∫–∞ -->
      <div class="tab-pane fade" id="retentionTab" role="tabpanel" aria-labelledby="retention-tab">
        <div class="card card-info card-outline">
          <div class="card-header"><h3 class="card-title">Retention</h3></div>
          <div class="card-body"><canvas id="retentionChart" style="height: 300px;"></canvas></div>
        </div>
      </div>

    </div>
  </div>
</section>

<!-- –õ–æ–≥–∏ –∑–∞–¥–∞—á -->
<section class="content mt-4">
  <div class="container-fluid">
    <h3>–õ–æ–≥–∏ –∑–∞–¥–∞—á</h3>
    <% if (taskLogs && taskLogs.length) { %>
      <pre class="bg-dark text-white p-3 rounded" style="max-height: 300px; overflow-y: auto;"><%= taskLogs.join('\n') %></pre>
    <% } else { %>
      <p>–õ–æ–≥–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</p>
    <% } %>
  </div>
</section>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    let charts = {};
    const usersTable = new DataTable('#usersTable', {
        paging: true, searching: true, ordering: true, order: [[0, 'desc']], scrollX: true,
        language: { url: 'https://cdn.datatables.net/plug-ins/1.10.25/i18n/Russian.json' }
    });

    function initializeOrUpdateChart(id, type, data, options) {
        const ctx = document.getElementById(id)?.getContext('2d');
        if (!ctx) return;
        if (charts[id]) charts[id].destroy();
        charts[id] = new Chart(ctx, { type, data, options });
    }
    
    // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç EJS
    initializeOrUpdateChart('combinedChart', 'line', <%- JSON.stringify(chartDataCombined || {}) %>, { responsive: true, scales: { y: { beginAtZero: true } } });
    initializeOrUpdateChart('hourActivityChart', 'bar', <%- JSON.stringify(chartDataHourActivity || {}) %>, { responsive: true, scales: { y: { beginAtZero: true } } });
    initializeOrUpdateChart('weekdayActivityChart', 'bar', <%- JSON.stringify(chartDataWeekdayActivity || {}) %>, { responsive: true, scales: { y: { beginAtZero: true } } });
    initializeOrUpdateChart('funnelChart', 'bar', <%- JSON.stringify(chartDataFunnel || {}) %>, { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } } });
    initializeOrUpdateChart('retentionChart', 'line', <%- JSON.stringify(chartDataRetention || {}) %>, { responsive: true, scales: { y: { beginAtZero: true } } });
    // –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
    initializeOrUpdateChart('heatmapChart', 'bar', <%- JSON.stringify(chartDataHeatmap || {}) %>, { responsive: true });
    initializeOrUpdateChart('userFunnelChart', 'bar', <%- JSON.stringify(chartDataUserFunnel || {}) %>, { responsive: true });

    // === –õ–û–ì–ò–ö–ê AJAX-–û–ë–ù–û–í–õ–ï–ù–ò–Ø ===
    const filtersForm = document.getElementById('filtersForm');

    async function updateDashboard() {
        const formData = new FormData(filtersForm);
        const params = new URLSearchParams(formData);
        const url = `/api/dashboard-data?${params.toString()}`;

        document.body.style.cursor = 'wait';
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–ª–∞—à–∫–∏
            document.querySelector('[data-stat="totalUsers"]').textContent = data.stats.totalUsers;
            document.querySelector('[data-stat="totalDownloads"]').textContent = data.stats.totalDownloads;
            document.querySelector('[data-stat="tariffs"]').textContent = ` ${data.stats.free} / ${data.stats.plus} / ${data.stats.pro} / ${data.stats.unlimited}`;

            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
            initializeOrUpdateChart('combinedChart', 'line', data.chartDataCombined, { responsive: true, scales: { y: { beginAtZero: true } } });
            initializeOrUpdateChart('hourActivityChart', 'bar', data.chartDataHourActivity, { responsive: true, scales: { y: { beginAtZero: true } } });
            initializeOrUpdateChart('weekdayActivityChart', 'bar', data.chartDataWeekdayActivity, { responsive: true, scales: { y: { beginAtZero: true } } });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç
            document.getElementById('exportLink').href = `/export?${params.toString()}`;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞—à–±–æ—Ä–¥–∞:', error);
        } finally {
            document.body.style.cursor = 'default';
        }
    }

    filtersForm.addEventListener('change', updateDashboard);

    // === REAL-TIME –ú–û–ù–ò–¢–û–†–ò–ù–ì –û–ß–ï–†–ï–î–ò ===
    const queueActiveEl = document.getElementById('queueActive');
    const queueSizeEl = document.getElementById('queueSize');
    async function updateQueueStatus() {
        try {
            const response = await fetch('/api/queue-status');
            if (!response.ok) return;
            const data = await response.json();
            queueActiveEl.textContent = data.active;
            queueSizeEl.textContent = data.size;
        } catch (e) {
            queueActiveEl.textContent = 'err';
            queueSizeEl.textContent = 'err';
        }
    }
    updateQueueStatus();
    setInterval(updateQueueStatus, 5000);
  });
</script>