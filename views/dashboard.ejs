<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

  <!-- DataTables Bootstrap 5 CSS -->
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />

  <!-- jQuery –∏ DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ */
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1, h3 {
      margin-bottom: 15px;
      color: #f0f0f0;
    }
    .chart-container {
      width: 100%;
      max-width: 900px;
      margin-bottom: 40px;
      height: 250px;
    }
    .inactive {
      color: #777 !important;
    }
    .pagination-controls button {
      margin-right: 5px;
    }
    a, a:hover, a:focus {
      color: #0d6efd;
      text-decoration: none;
    }
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
    .stat-card {
      background-color: #1e1e1e;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 15px;
      color: #ddd;
      box-shadow: 0 0 8px rgba(0,0,0,0.7);
    }
    /* –§–æ—Ä–º—ã */
    form label {
      user-select: none;
    }
    /* –¢–∞–±–ª–∏—Ü–∞ */
    table.dataTable tbody tr {
      background-color: #1e1e1e;
      color: #ddd;
    }
    table.dataTable thead {
      background-color: #333;
      color: #eee;
    }
    /* –ö–Ω–æ–ø–∫–∏ */
    button {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä Admin Dashboard</h1>

    <form method="GET" action="/dashboard" class="mb-3 d-flex align-items-center gap-3 flex-wrap">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="showInactive" id="showInactive" value="true" <%= showInactive ? 'checked' : '' %>>
        <label class="form-check-label" for="showInactive">–ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö</label>
      </div>
      <button type="submit" class="btn btn-primary btn-sm">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <a href="/export" class="btn btn-outline-light btn-sm ms-auto">üìÅ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</a>
    </form>

    <% if (showInactive) { %>
      <form method="POST" action="/delete-inactive" class="mb-3">
        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?')">üóë –£–¥–∞–ª–∏—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö</button>
      </form>
    <% } %>

    <div class="row mb-4">
      <div class="col-md-3 stat-card">
        <h5>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
        <p class="fs-4"><%= stats.totalUsers %></p>
      </div>
      <div class="col-md-3 stat-card">
        <h5>–ó–∞–≥—Ä—É–∑–æ–∫</h5>
        <p class="fs-4"><%= stats.totalDownloads %></p>
      </div>
      <div class="col-md-6 stat-card">
        <h5>–¢–∞—Ä–∏—Ñ—ã</h5>
        <p>Free: <%= stats.free %>, Plus: <%= stats.plus %>, Pro: <%= stats.pro %>, Unlim: <%= stats.unlimited %></p>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="combinedChart"></canvas>
    </div>

    <div class="row">
      <div class="col-md-6 chart-container">
        <canvas id="hourActivityChart"></canvas>
      </div>
      <div class="col-md-6 chart-container">
        <canvas id="weekdayActivityChart"></canvas>
      </div>
    </div>

    <h3>üóì –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –¥–∞—Ç–µ –∏ —á–∞—Å—É (—Ç–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞)</h3>
    <div class="chart-container" style="height: 400px;">
      <canvas id="heatmapChart"></canvas>
    </div>

    <details class="mb-4 text-light">
      <summary>–ü–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –¥–∞—Ç–µ –∏ —á–∞—Å—É (JSON)</summary>
      <pre><%= JSON.stringify(stats.activityByDayHour || {}, null, 2) %></pre>
    </details>

    <h3>üïí –° —Ç–∞—Ä–∏—Ñ–æ–º, –∏—Å—Ç–µ–∫–∞—é—â–∏–º –≤ –±–ª–∏–∂–∞–π—à–∏–µ 3 –¥–Ω—è</h3>

    <form id="paginationForm" method="GET" action="/dashboard" class="mb-3 d-flex align-items-center gap-3 flex-wrap">
      <input type="hidden" name="showInactive" value="<%= showInactive ? 'true' : '' %>">
      <label class="d-flex align-items-center gap-2">
        –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ: 
        <select name="expiringLimit" id="expiringLimit" class="form-select form-select-sm ms-2" onchange="document.getElementById('paginationForm').submit()">
          <option value="5" <%= expiringLimit == 5 ? 'selected' : '' %>>5</option>
          <option value="10" <%= expiringLimit == 10 ? 'selected' : '' %>>10</option>
          <option value="25" <%= expiringLimit == 25 ? 'selected' : '' %>>25</option>
          <option value="50" <%= expiringLimit == 50 ? 'selected' : '' %>>50</option>
          <option value="100" <%= expiringLimit == 100 ? 'selected' : '' %>>100</option>
        </select>
      </label>
      <input type="hidden" name="expiringOffset" id="expiringOffset" value="<%= expiringOffset || 0 %>">
    </form>

    <% if (expiringSoon.length === 0) { %>
      <p>–ù–µ—Ç —Ç–∞–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
    <% } else { %>
      <ul class="list-group mb-3">
        <% expiringSoon.forEach(u => { %>
          <li class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center">
            <span><%= u.first_name %> (<%= u.username ? '@' + u.username : '‚Äî' %>) ‚Äî –¥–æ <%= new Date(u.premium_until).toLocaleDateString() %></span>
          </li>
        <% }) %>
      </ul>

      <div class="pagination-controls mb-4">
        <% if (expiringOffset > 0) { %>
          <button class="btn btn-outline-primary btn-sm" onclick="changePage(-1)">‚Üê –ù–∞–∑–∞–¥</button>
        <% } %>
        <% if (expiringOffset + expiringLimit < expiringCount) { %>
          <button class="btn btn-outline-primary btn-sm" onclick="changePage(1)">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
        <% } %>
        <span class="ms-2">–ü–æ–∫–∞–∑–∞–Ω–æ <%= expiringOffset + 1 %>‚Äì<%= Math.min(expiringOffset + expiringLimit, expiringCount) %> –∏–∑ <%= expiringCount %></span>
      </div>
    <% } %>

    <h3>üìà –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞</h3>
    <table class="table table-dark table-striped table-bordered">
      <thead>
        <tr><th>–ò—Å—Ç–æ—á–Ω–∏–∫</th><th>–ö–æ–ª-–≤–æ</th></tr>
      </thead>
      <tbody>
        <% referralStats.forEach(source => { %>
          <tr>
            <td><%= source.source || '‚Äî' %></td>
            <td><%= source.count %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>

    <h3>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (<%= users.length %>)</h3>
    <table id="usersTable" class="table table-dark table-striped table-bordered">
      <thead>
        <tr>
          <th>ID</th><th>Username</th><th>–ò–º—è</th><th>–°–∫–∞—á–∞–Ω–æ</th><th>–õ–∏–º–∏—Ç</th>
          <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th><th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ò—Å—Ç–æ—á–Ω–∏–∫</th><th>–¢–∞—Ä–∏—Ñ</th>
        </tr>
      </thead>
      <tbody>
        <% users.forEach(user => { %>
          <tr class="<%= !user.active ? 'inactive' : '' %>">
            <td><%= user.id %></td>
            <td><%= user.username ? '@' + user.username : '' %></td>
            <td>
              <%= user.first_name %> 
              <% if (new Date(user.created_at) > Date.now() - 24 * 60 * 60 * 1000) { %>üÜï<% } %>
            </td>
            <td><%= user.total_downloads || 0 %></td>
            <td><%= user.premium_limit %></td>
            <td><%= user.created_at ? new Date(user.created_at).toLocaleDateString() : '-' %></td>
            <td><%= user.last_active ? new Date(user.last_active).toLocaleDateString() : '-' %></td>
            <td>
              <% if (!user.last_active) { %>üî¥
              <% } else if (new Date(user.last_active) > Date.now() - 24 * 60 * 60 * 1000) { %>üü¢
              <% } else { %>üü°<% } %>
            </td>
            <td><%= user.referral_source || '‚Äî' %></td>
            <td>
              <form method="POST" action="/set-tariff" class="d-flex align-items-center gap-2" style="margin:0;">
                <input type="hidden" name="userId" value="<%= user.id %>">
                <select name="limit" class="form-select form-select-sm">
                  <option value="10" <%= user.premium_limit === 10 ? 'selected' : '' %>>Free</option>
                  <option value="50" <%= user.premium_limit === 50 ? 'selected' : '' %>>Plus</option>
                  <option value="100" <%= user.premium_limit === 100 ? 'selected' : '' %>>Pro</option>
                  <option value="1000" <%= user.premium_limit >= 1000 ? 'selected' : '' %>>Unlimited</option>
                </select>
                <button type="submit" class="btn btn-sm btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>

    <h3>üì¢ –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</h3>
    <form method="POST" action="/broadcast" enctype="multipart/form-data" class="mb-5">
      <textarea name="message" rows="4" class="form-control mb-2" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç" required></textarea>
      <input type="file" name="audio" class="form-control mb-2" accept="audio/*">
      <button type="submit" class="btn btn-success">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  </div>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script>
    // DataTables –∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
    $(document).ready(() => {
      $('#usersTable').DataTable({
        order: [[5, 'desc']],
        language: {
          search: "–ü–æ–∏—Å–∫:",
          lengthMenu: "–ü–æ–∫–∞–∑–∞—Ç—å _MENU_ –∑–∞–ø–∏—Å–µ–π",
          info: "–ü–æ–∫–∞–∑–∞–Ω–æ _START_ - _END_ –∏–∑ _TOTAL_",
          paginate: {
            first: "–ü–µ—Ä–≤–∞—è", last: "–ü–æ—Å–ª–µ–¥–Ω—è—è", next: "–°–ª–µ–¥—É—é—â–∞—è", previous: "–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
          },
          zeroRecords: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
        }
      });
    });

    // –¢–≤–æ–∏ –≥—Ä–∞—Ñ–∏–∫–∏ Chart.js ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    // ...

    // –§—É–Ω–∫—Ü–∏—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –¥–ª—è –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö —Ç–∞—Ä–∏—Ñ–æ–≤
    function changePage(delta) {
      const offsetInput = document.getElementById('expiringOffset');
      let offset = parseInt(offsetInput.value, 10) || 0;
      const limit = parseInt(document.getElementById('expiringLimit').value, 10) || 10;
      offset += delta * limit;
      if (offset < 0) offset = 0;
      offsetInput.value = offset;
      document.getElementById('paginationForm').submit();
    }
  </script>
</body>
</html>