<% layout('layout', { title: '–ê–¥–º–∏–Ω–∫–∞', page: 'dashboard' }) %>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<section class="content-header">
  <div class="container-fluid d-flex justify-content-between align-items-center mb-3">
    <h1>üìä –ê–¥–º–∏–Ω–∫–∞</h1>
    <small>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <%= user ? (user.username || user.first_name) : '–ì–æ—Å—Ç—å' %></small>
  </div>
</section>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
<section class="content">
  <div class="container-fluid">

    <!-- –í–∫–ª–∞–¥–∫–∏ -->
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab" aria-controls="stats" aria-selected="true">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#usersTab" type="button" role="tab" aria-controls="usersTab" aria-selected="false">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="broadcast-tab" data-bs-toggle="tab" data-bs-target="#broadcastTab" type="button" role="tab" aria-controls="broadcastTab" aria-selected="false">–†–∞—Å—Å—ã–ª–∫–∞</button>
      </li>
    </ul>

    <div class="tab-content mt-3" id="dashboardTabsContent">

      <!-- –í–∫–ª–∞–¥–∫–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="tab-pane fade show active" id="stats" role="tabpanel" aria-labelledby="stats-tab">

        <form method="GET" action="/dashboard" class="d-flex align-items-center gap-3 mb-3 flex-wrap">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="showInactive" name="showInactive" value="true" <%= showInactive ? 'checked' : '' %>>
            <label class="form-check-label" for="showInactive">–ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö</label>
          </div>
          <button type="submit" class="btn btn-primary btn-sm">–û–±–Ω–æ–≤–∏—Ç—å</button>
          <a href="/export" class="btn btn-secondary btn-sm">üìÅ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</a>
        </form>

        <div class="row mb-3">
          <div class="col-md-4">
            <div class="info-box bg-info">
              <span class="info-box-icon"><i class="fas fa-users"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
                <span class="info-box-number"><%= stats.totalUsers %></span>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="info-box bg-success">
              <span class="info-box-icon"><i class="fas fa-download"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">–í—Å–µ–≥–æ –∑–∞–≥—Ä—É–∑–æ–∫</span>
                <span class="info-box-number"><%= stats.totalDownloads %></span>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="info-box bg-warning">
              <span class="info-box-icon"><i class="fas fa-star"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">–¢–∞—Ä–∏—Ñ—ã (Free/Plus/Pro/Unlim)</span>
                <span class="info-box-number">
                  Free: <%= stats.free %>, Plus: <%= stats.plus %>, Pro: <%= stats.pro %>, Unlim: <%= stats.unlimited %>
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="card card-primary card-outline">
          <div class="card-header">
            <h3 class="card-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –ó–∞–≥—Ä—É–∑–∫–∏, –ê–∫—Ç–∏–≤–Ω—ã–µ</h3>
          </div>
          <div class="card-body">
            <canvas id="combinedChart" style="height: 250px;"></canvas>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-6">
            <div class="card card-info card-outline">
              <div class="card-header">
                <h3 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º</h3>
              </div>
              <div class="card-body">
                <canvas id="hourActivityChart" style="height: 250px;"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card card-info card-outline">
              <div class="card-header">
                <h3 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</h3>
              </div>
              <div class="card-body">
                <canvas id="weekdayActivityChart" style="height: 250px;"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ -->
        <div class="card card-secondary card-outline mt-3">
          <div class="card-header">
            <h3 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–∞—Ç–µ –∏ —á–∞—Å—É (—Ç–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞)</h3>
          </div>
          <div class="card-body" style="height: 400px;">
            <canvas id="heatmapChart"></canvas>
          </div>
          <details class="mt-3">
            <summary>–ü–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –¥–∞—Ç–µ –∏ —á–∞—Å—É (JSON)</summary>
            <pre><%= JSON.stringify(stats.activityByDayHour || {}, null, 2) %></pre>
          </details>
        </div>

        <!-- –° —Ç–∞—Ä–∏—Ñ–æ–º, –∏—Å—Ç–µ–∫–∞—é—â–∏–º –≤ –±–ª–∏–∂–∞–π—à–∏–µ 3 –¥–Ω—è -->
        <div class="card card-danger card-outline mt-3">
          <div class="card-header">
            <h3 class="card-title">–° —Ç–∞—Ä–∏—Ñ–æ–º, –∏—Å—Ç–µ–∫–∞—é—â–∏–º –≤ –±–ª–∏–∂–∞–π—à–∏–µ 3 –¥–Ω—è</h3>
          </div>
          <div class="card-body">
            <% if (expiringSoon.length === 0) { %>
              <p>–ù–µ—Ç —Ç–∞–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
            <% } else { %>
              <ul class="list-group">
                <% expiringSoon.forEach(u => { %>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><%= u.first_name %> (<%= u.username ? '@' + u.username : '‚Äî' %>)</span>
                    <span>–î–æ <%= new Date(u.premium_until).toLocaleDateString() %></span>
                  </li>
                <% }) %>
              </ul>

              <nav aria-label="–ü–∞–≥–∏–Ω–∞—Ü–∏—è" class="mt-3 d-flex justify-content-center">
                <ul class="pagination mb-0">
                  <% if (expiringOffset > 0) { %>
                    <li class="page-item">
                      <button class="page-link" onclick="changePage(-1)">‚Üê –ù–∞–∑–∞–¥</button>
                    </li>
                  <% } %>
                  <% if (expiringOffset + expiringLimit < expiringCount) { %>
                    <li class="page-item">
                      <button class="page-link" onclick="changePage(1)">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
                    </li>
                  <% } %>
                </ul>
              </nav>
              <p class="text-center text-muted">–ü–æ–∫–∞–∑–∞–Ω–æ <%= expiringOffset + 1 %>‚Äì<%= Math.min(expiringOffset + expiringLimit, expiringCount) %> –∏–∑ <%= expiringCount %></p>
            <% } %>
          </div>
        </div>

        <!-- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ -->
        <div class="card card-light card-outline mt-3">
          <div class="card-header">
            <h3 class="card-title">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞</h3>
          </div>
          <div class="card-body p-0">
            <table class="table table-striped table-hover mb-0">
              <thead class="thead-light">
                <tr>
                  <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                  <th>–ö–æ–ª-–≤–æ</th>
                </tr>
              </thead>
              <tbody>
                <% referralStats.forEach(source => { %>
                  <tr>
                    <td><%= source.source ? source.source.replace(/</g, "&lt;").replace(/>/g, "&gt;") : '‚Äî' %></td>
                    <td><%= source.count %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>

      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
      <div class="tab-pane fade" id="usersTab" role="tabpanel" aria-labelledby="users-tab">

        <table id="usersTable" class="table table-bordered table-hover w-100">
          <thead>
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>–ò–º—è</th>
              <th>–°–∫–∞—á–∞–Ω–æ</th>
              <th>–õ–∏–º–∏—Ç</th>
              <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
              <th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
              <th>–¢–∞—Ä–∏—Ñ</th>
            </tr>
          </thead>
          <tbody>
            <% users.forEach(user => { %>
              <tr class="<%= !user.active ? 'table-secondary' : '' %>">
                <td><%= user.id %></td>
                <td><%= user.username ? '@' + user.username : '' %></td>
                <td>
                  <%= user.first_name %>
                  <% if (user.created_at && new Date(user.created_at) > Date.now() - 24 * 60 * 60 * 1000) { %>
                    <span class="badge bg-info text-dark">üÜï</span>
                  <% } %>
                </td>
                <td><%= user.total_downloads || 0 %></td>
                <td><%= user.premium_limit %></td>
                <td><%= user.created_at ? new Date(user.created_at).toLocaleDateString() : '-' %></td>
                <td><%= user.last_active ? new Date(user.last_active).toLocaleDateString() : '-' %></td>
                <td>
                  <% if (!user.last_active) { %>üî¥
                  <% } else if (new Date(user.last_active) > Date.now() - 24 * 60 * 60 * 1000) { %>üü¢
                  <% } else { %>üü°
                  <% } %>
                </td>
                <td><%= user.referral_source ? user.referral_source.replace(/</g, "&lt;").replace(/>/g, "&gt;") : '‚Äî' %></td>
                <td>
                  <form method="POST" action="/set-tariff" class="d-flex align-items-center gap-2 m-0">
                    <input type="hidden" name="userId" value="<%= user.id %>">
                    <select name="limit" class="form-select form-select-sm">
                      <option value="10" <%= user.premium_limit === 10 ? 'selected' : '' %>>Free</option>
                      <option value="50" <%= user.premium_limit === 50 ? 'selected' : '' %>>Plus</option>
                      <option value="100" <%= user.premium_limit === 100 ? 'selected' : '' %>>Pro</option>
                      <option value="1000" <%= user.premium_limit >= 1000 ? 'selected' : '' %>>Unlimited</option>
                    </select>
                    <button type="submit" class="btn btn-primary btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>

      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ –†–∞—Å—Å—ã–ª–∫–∞ -->
      <div class="tab-pane fade" id="broadcastTab" role="tabpanel" aria-labelledby="broadcast-tab">
        <form method="POST" action="/broadcast" enctype="multipart/form-data" class="mb-3">
          <div class="mb-3">
            <label for="broadcastMessage" class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
            <textarea id="broadcastMessage" name="message" class="form-control" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç"></textarea>
          </div>
          <div class="mb-3">
            <label for="broadcastAudio" class="form-label">–ê—É–¥–∏–æ—Ñ–∞–π–ª (mp3)</label>
            <input type="file" id="broadcastAudio" name="audio" accept="audio/mp3,audio/mpeg" class="form-control" />
          </div>
          <button type="submit" class="btn btn-success">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
      </div>

    </div>
  </div>
</section>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>

<script>
  $(function () {
    $('#usersTable').DataTable({
      order: [[5, 'desc']],
      language: {
        search: "–ü–æ–∏—Å–∫:",
        lengthMenu: "–ü–æ–∫–∞–∑–∞—Ç—å _MENU_ –∑–∞–ø–∏—Å–µ–π",
        info: "–ü–æ–∫–∞–∑–∞–Ω–æ _START_ - _END_ –∏–∑ _TOTAL_",
        paginate: {
          first: "–ü–µ—Ä–≤–∞—è", last: "–ü–æ—Å–ª–µ–¥–Ω—è—è", next: "–°–ª–µ–¥—É—é—â–∞—è", previous: "–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
        },
        zeroRecords: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
      }
    });

    // –î–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
    const combinedLabels = <%- JSON.stringify(Object.keys(stats.registrationsByDate)) %>;
    const registrationsData = <%- JSON.stringify(Object.values(stats.registrationsByDate)) %>;
    const downloadsData = <%- JSON.stringify(Object.values(stats.downloadsByDate)) %>;
    const activeUsersData = <%- JSON.stringify(Object.values(stats.activeByDate)) %>;

    new Chart(document.getElementById('combinedChart'), {
      type: 'line',
      data: {
        labels: combinedLabels,
        datasets: [
          {
            label: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ä–∞—Ü–∏–∏',
            data: registrationsData,
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.3)',
            fill: true,
            tension: 0.3,
          },
          {
            label: '–ó–∞–≥—Ä—É–∑–∫–∏',
            data: downloadsData,
            borderColor: '#198754',
            backgroundColor: 'rgba(25, 135, 84, 0.3)',
            fill: true,
            tension: 0.3,
          },
          {
            label: '–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
            data: activeUsersData,
            borderColor: '#ffc107',
            backgroundColor: 'rgba(255, 193, 7, 0.3)',
            fill: true,
            tension: 0.3,
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        stacked: false,
        scales: { y: { beginAtZero: true } }
      }
    });

    // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º
    const hoursLabels = Array.from({length:24}, (_,i) => i + ':00');
    const activityByHour = <%- JSON.stringify(activityByHour || Array(24).fill(0)) %>;

    new Chart(document.getElementById('hourActivityChart'), {
      type: 'bar',
      data: {
        labels: hoursLabels,
        datasets: [{
          label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º',
          data: activityByHour,
          backgroundColor: 'rgba(13, 110, 253, 0.7)',
          borderColor: 'rgba(13, 110, 253, 1)',
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true },
          x: { title: { display: true, text: '–ß–∞—Å—ã' } }
        }
      }
    });

    // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏
    const weekdaysLabels = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
    const activityByWeekday = <%- JSON.stringify(activityByWeekday || Array(7).fill(0)) %>;

    new Chart(document.getElementById('weekdayActivityChart'), {
      type: 'bar',
      data: {
        labels: weekdaysLabels,
        datasets: [{
          label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏',
          data: activityByWeekday,
          backgroundColor: 'rgba(25, 135, 84, 0.7)',
          borderColor: 'rgba(25, 135, 84, 1)',
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true },
          x: { title: { display: true, text: '–î–Ω–∏ –Ω–µ–¥–µ–ª–∏' } }
        }
      }
    });

    // –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    const activityByDayHour = <%- JSON.stringify(stats.activityByDayHour || {}) %>;
    const days = Object.keys(activityByDayHour).sort();
    const hours = Array.from({length: 24}, (_, i) => i);

    const heatmapDatasets = hours.map(hour => ({
      label: hour + ':00',
      data: days.map(day => (activityByDayHour[day] ? activityByDayHour[day][hour] || 0 : 0)),
      backgroundColor: function(context) {
        const value = context.dataset.data[context.dataIndex];
        const alpha = Math.min(value / 3, 1);
        return `rgba(54, 162, 235, ${alpha})`;
      },
      borderWidth: 0
    }));

    const ctxHeatmap = document.getElementById('heatmapChart').getContext('2d');
    new Chart(ctxHeatmap, {
      type: 'bar',
      data: {
        labels: days,
        datasets: heatmapDatasets
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        scales: {
          x: { stacked: true, display: false },
          y: { stacked: true }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });
  });

  function changePage(delta) {
    const url = new URL(window.location.href);
    const offset = parseInt(url.searchParams.get('expiringOffset') || '0');
    let newOffset = offset + delta * <%= expiringLimit %>;
    if (newOffset < 0) newOffset = 0;
    url.searchParams.set('expiringOffset', newOffset);
    window.location.href = url.toString();
  }
</script>