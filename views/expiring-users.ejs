<%
// Хелпер: формат тарифа
function tariffLabel(limit) {
  if (limit >= 1000) return 'Unlimited (∞/д)';
  if (limit === 100) return 'Pro (100/д)';
  if (limit === 30) return 'Plus (30/д)';
  return 'Free (5/д)';
}

// Хелпер: безопасно форматируем дату из БД
function formatDate(s) {
  if (!s) return '-';
  try {
    const iso = String(s).replace(' ', 'T').replace(/Z?$/, 'Z');
    const d = new Date(iso);
    if (isNaN(d)) return '-';
    return d.toLocaleDateString('ru-RU');
  } catch (e) {
    return '-';
  }
}
%>

<div class="card shadow-sm">
  <div class="card-header d-flex align-items-center justify-content-between">
    <span class="h5 mb-0">⏳ Истекающие подписки</span>
    <% if (typeof totalPages !== 'undefined') { %>
      <small class="text-muted">Страниц: <%= totalPages %></small>
    <% } %>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Имя</th>
            <th>Username</th>
            <th>Тариф</th>
            <th>До</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          <% if (!users || users.length === 0) { %>
            <tr>
              <td colspan="6" class="text-center text-muted py-4">Нет данных</td>
            </tr>
          <% } else { %>
            <% users.forEach(u => { %>
              <tr>
                <td><%= u.id %></td>
                <td><%= u.first_name || '' %></td>
                <td><%= u.username ? '@'+u.username : '' %></td>
                <td><%= tariffLabel(u.premium_limit) %></td>
                <td><%= formatDate(u.premium_until) %></td>
                <td>
                  <a href="/user/<%= u.id %>" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye"></i> Открыть
                  </a>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Скрипты для обработки уведомлений -->
<script>
  document.querySelectorAll('.alert[data-autohide]').forEach(el => {
    setTimeout(() => {
      el.classList.add('d-none');
    }, 4000);
  });
</script>

<!-- CSS для улучшения визуализации -->
<style>
  .card-header {
    background-color: #007bff;
    color: #fff;
  }
  .table th {
    background-color: #f8f9fa;
  }
  .table-hover tbody tr:hover {
    background-color: #f1f1f1;
  }
  .btn-outline-primary {
    color: #007bff;
    border-color: #007bff;
  }
  .btn-outline-primary:hover {
    background-color: #007bff;
    color: #fff;
  }
</style>