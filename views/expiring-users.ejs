<%
// Хелпер: формат тарифа
function tariffLabel(limit) {
  if (limit >= 1000) return 'Unlimited (∞/д)';
  if (limit === 100) return 'Pro (100/д)';
  if (limit === 30) return 'Plus (30/д)';
  return 'Free (5/д)';
}

// Хелпер: безопасно форматируем дату из БД
function formatDate(s) {
  if (!s) return '-';
  try {
    // приводим к ISO: заменяем пробел на 'T' и добавляем Z (UTC)
    const iso = String(s).replace(' ', 'T').replace(/Z?$/, 'Z');
    const d = new Date(iso);
    if (isNaN(d)) return '-';
    return d.toLocaleDateString('ru-RU');
  } catch (e) {
    return '-';
  }
}
%>

<div class="card shadow-sm">
  <div class="card-header d-flex align-items-center justify-content-between">
    <span>Истекающие подписки</span>
    <small class="text-muted">Всего: <%= totalPages ? (totalPages * 10) : (users?.length || 0) %></small>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Имя</th>
            <th>Username</th>
            <th>Тариф</th>
            <th>До</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% if ((users || []).length === 0) { %>
            <tr>
              <td colspan="6" class="text-center text-muted py-4">Пока пусто</td>
            </tr>
          <% } else { %>
            <% users.forEach(u => { %>
              <tr>
                <td><%= u.id %></td>
                <td><%= u.first_name || '' %></td>
                <td><%= u.username ? '@'+u.username : '' %></td>
                <td><%= tariffLabel(u.premium_limit) %></td>
                <td><%= formatDate(u.premium_until) %></td>
                <td><a href="/user/<%= u.id %>" class="btn btn-sm btn-outline-primary">Открыть</a></td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>